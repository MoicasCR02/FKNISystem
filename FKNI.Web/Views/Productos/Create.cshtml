@model FKNI.Application.DTOs.ProductosDTO

@{
    ViewData["Title"] = "Crear Producto";
}

<!-- Create Product Header -->
<section class="section bg-nude-light">
    <div class="container container-narrow">
        <div class="section-header">
            <h1 class="section-title">Crear Producto</h1>
            <p class="section-subtitle">Registra un nuevo producto con su información, imágenes y etiquetas</p>
        </div>
    </div>
</section>

<!-- Product Form -->
<section class="section">
    <div class="container container-narrow content-with-footer-space">

        <!-- Welcome Card -->
        <div class="product-welcome-card mb-8">
            <div class="welcome-content">
                <div class="welcome-icon">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="welcome-text">
                    <h3 class="welcome-title">¡Crea Productos Únicos!</h3>
                    <p class="welcome-subtitle">Agrega diseños exclusivos de Moicas al catálogo de Fucking Industry</p>
                </div>
            </div>
        </div>

        <!-- Form Card -->
        <div class="card shadow-lg">
            <div class="card-body">
                <form asp-action="Create" enctype="multipart/form-data" id="formCreateProducto" class="modern-form" onsubmit="return validarFormulario();">
                    <div asp-validation-summary="ModelOnly" class="form-error mb-6"></div>

                    <!-- Basic Information Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">
                            <i class="bi bi-info-circle"></i>
                            Información Básica
                        </h3>

                        <!-- Nombre del producto -->
                        <div class="form-group">
                            <label asp-for="NombreProducto" class="form-label">
                                <i class="bi bi-tag"></i>
                                Nombre del producto
                            </label>
                            <input asp-for="NombreProducto" class="form-input" required minlength="3" placeholder="Ej: Camiseta Urban Street" />
                            <span class="form-error" id="errorNombre"></span>
                        </div>

                        <!-- Descripción -->
                        <div class="form-group">
                            <label asp-for="Descripcion" class="form-label">
                                <i class="bi bi-card-text"></i>
                                Descripción detallada
                            </label>
                            <textarea asp-for="Descripcion" class="form-textarea" rows="3" required minlength="10" placeholder="Describe las características, materiales y estilo del producto..."></textarea>
                            <span class="form-error" id="errorDescripcion"></span>
                        </div>
                    </div>

                    <!-- Pricing & Inventory Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">
                            <i class="bi bi-currency-dollar"></i>
                            Precio e Inventario
                        </h3>

                        <div class="form-grid-2">
                            <div class="form-group">
                                <label asp-for="Precio" class="form-label">
                                    <i class="bi bi-cash"></i>
                                    Precio (₡)
                                </label>
                                <input asp-for="Precio" class="form-input" type="number" min="0.01" step="0.01" required placeholder="15000.00" />
                                <span class="form-error" id="errorPrecio"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Stock" class="form-label">
                                    <i class="bi bi-boxes"></i>
                                    Stock disponible
                                </label>
                                <input asp-for="Stock" class="form-input" type="number" min="0" required placeholder="50" />
                                <span class="form-error" id="errorStock"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Classification Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">
                            <i class="bi bi-collection"></i>
                            Clasificación
                        </h3>

                        <!-- Categoría -->
                        <div class="form-group">
                            <label asp-for="IdCategoria" class="form-label">
                                <i class="bi bi-folder"></i>
                                Categoría
                            </label>
                            @Html.DropDownListFor(m => m.IdCategoria,
                            new SelectList(ViewBag.ListCategoria, "IdCategoria", "NombreCategoria"),
                                                        "Seleccione una categoría",
                                                        new { @class = "form-select", required = "required" })
                            <span class="form-error" id="errorCategoria"></span>
                        </div>

                        <!-- Etiquetas -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-tags"></i>
                                Etiquetas
                            </label>
                            <select id="selectedEtiquetas" name="selectedEtiquetas"
                                    class="form-select form-select-tags" asp-items="ViewBag.ListEtiquetas"
                                    multiple="multiple" required></select>
                            <small class="form-help">
                                <i class="bi bi-info-circle"></i>
                                Use Ctrl o Cmd para seleccionar varias.
                            </small>
                            <span class="form-error" id="errorEtiquetas"></span>
                        </div>
                    </div>

                    <!-- Images Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">
                            <i class="bi bi-images"></i>
                            Imágenes del Producto
                        </h3>

                        <div class="form-group">
                            <label for="ImageFiles" class="form-label">
                                <i class="bi bi-cloud-upload"></i>
                                Cargar Imágenes
                            </label>
                            <input type="file" id="ImageFiles" name="ImageFiles" multiple accept="image/*" class="form-input file-input" required />
                            <small class="form-help">
                                <i class="bi bi-exclamation-triangle"></i>
                                Debe cargar al menos una imagen del producto
                            </small>

                            <!-- Image Preview Grid -->
                            <div id="previewList" class="image-preview-grid-simple"></div>
                            <span class="form-error" id="errorImagenes"></span>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <a asp-action="IndexAdmin" class="btn btn-ghost btn-lg">
                            <i class="bi bi-arrow-left"></i>
                            Cancelar
                        </a>
                        <button type="submit" id="btnSubmit" class="btn btn-primary btn-lg btn-submit">
                            <i class="bi bi-save"></i>
                            <span class="btn-text">Guardar producto</span>
                            <div id="spinner" class="btn-spinner">
                                <i class="bi bi-arrow-clockwise"></i>
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        let selectedFiles = []; // Array para mantener los archivos seleccionados

        // Tu lógica original exacta - Preview de imágenes MEJORADA
        document.getElementById('ImageFiles').addEventListener('change', function (event) {
            const previewContainer = document.getElementById('previewList');
            const newFiles = Array.from(event.target.files);

            // Agregar nuevos archivos al array existente
            selectedFiles = [...selectedFiles, ...newFiles];

            // Actualizar preview
            updatePreview();
        });

        function updatePreview() {
            const previewContainer = document.getElementById('previewList');
            previewContainer.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    // Crear contenedor de imagen con botón eliminar
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-preview-item-simple';

                    imageContainer.innerHTML = `
                        <div class="preview-image-wrapper">
                            <img src="${e.target.result}" alt="Preview ${index + 1}" style="max-width: 120px; max-height: 120px;" class="img-thumbnail">
                            <button type="button" class="remove-image-simple" onclick="removeImage(${index})" title="Eliminar imagen">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <div class="image-info-simple">
                            <span class="file-name-simple">${file.name}</span>
                        </div>
                    `;

                    previewContainer.appendChild(imageContainer);
                };
                reader.readAsDataURL(file);
            });

            // Actualizar el input file con los archivos actuales
            updateFileInput();
        }

        function removeImage(index) {
            // Eliminar archivo del array
            selectedFiles.splice(index, 1);

            // Actualizar preview
            updatePreview();

            // Mostrar notificación
            showNotification('🗑️ Imagen eliminada', 'success');
        }

        function updateFileInput() {
            const fileInput = document.getElementById('ImageFiles');
            const dt = new DataTransfer();

            selectedFiles.forEach(file => {
                dt.items.add(file);
            });

            fileInput.files = dt.files;
        }

        // Tu función de validación original exacta
        function validarFormulario() {
            let valido = true;

            const nombre = document.querySelector('[name="NombreProducto"]');
            const descripcion = document.querySelector('[name="Descripcion"]');
            const precio = document.querySelector('[name="Precio"]');
            const stock = document.querySelector('[name="Stock"]');
            const categoria = document.querySelector('[name="IdCategoria"]');
            const etiquetas = document.querySelector('#selectedEtiquetas');
            const imagenes = document.querySelector('#ImageFiles');

            document.querySelectorAll('span.form-error').forEach(span => span.textContent = '');

            if (!nombre.value || nombre.value.length < 3) {
                document.getElementById('errorNombre').textContent = "Debe ingresar un nombre de al menos 3 caracteres.";
                valido = false;
            }

            if (!descripcion.value || descripcion.value.length < 10) {
                document.getElementById('errorDescripcion').textContent = "La descripción debe tener al menos 10 caracteres.";
                valido = false;
            }

            if (!precio.value || parseFloat(precio.value) <= 0) {
                document.getElementById('errorPrecio').textContent = "Ingrese un precio mayor a ₡0.";
                valido = false;
            }

            if (!stock.value || parseInt(stock.value) < 0) {
                document.getElementById('errorStock').textContent = "El stock no puede ser negativo.";
                valido = false;
            }

            if (!categoria.value) {
                document.getElementById('errorCategoria').textContent = "Debe seleccionar una categoría.";
                valido = false;
            }

            if ([...etiquetas.selectedOptions].length === 0) {
                document.getElementById('errorEtiquetas').textContent = "Seleccione al menos una etiqueta.";
                valido = false;
            }

            if (!imagenes.files.length) {
                document.getElementById('errorImagenes').textContent = "Debe cargar al menos una imagen.";
                valido = false;
            }

            return valido;
        }

        // Enhanced form submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('formCreateProducto');
            const btnSubmit = document.getElementById('btnSubmit');
            const btnText = document.querySelector('.btn-text');
            const spinner = document.getElementById('spinner');

            form.addEventListener('submit', function(e) {
                if (validarFormulario()) {
                    // Show loading state
                    btnSubmit.disabled = true;
                    btnSubmit.classList.add('loading');
                    btnText.textContent = 'Guardando...';
                    spinner.style.display = 'block';

                    // Show notification
                    setTimeout(() => {
                        showNotification('📦 Creando producto...', 'success');
                    }, 100);
                }
            });
        });

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill'}"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
    </script>
}