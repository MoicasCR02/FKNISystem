@model FKNI.Application.DTOs.ProductosDTO
@{
    ViewData["Title"] = "Crear Producto";
}

<section class="section">
    <div class="container container-narrow content-with-footer-space">
        <header class="section-header">
            <h2 class="section-title">Crear Producto</h2>
            <p class="section-subtitle">Registra un nuevo producto con su información, imágenes y etiquetas.</p>
        </header>

        <div class="card shadow-lg">
            <div class="card-body">
                <form asp-action="Create" enctype="multipart/form-data" id="formCreateProducto" class="modern-form">
                    @Html.AntiForgeryToken()

                    <div asp-validation-summary="ModelOnly" class="form-error mb-6"></div>

                    <!-- Basic Information Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">Información Básica</h3>

                        <!-- Nombre -->
                        <div class="form-group">
                            <label asp-for="NombreProducto" class="form-label">
                                <i class="bi bi-tag"></i>
                                Nombre del Producto
                            </label>
                            <input asp-for="NombreProducto" class="form-input" placeholder="Ej: Camiseta Urban Street" />
                            <span asp-validation-for="NombreProducto" class="form-error"></span>
                        </div>

                        <!-- Descripción -->
                        <div class="form-group">
                            <label asp-for="Descripcion" class="form-label">
                                <i class="bi bi-card-text"></i>
                                Descripción
                            </label>
                            <textarea asp-for="Descripcion" class="form-textarea" rows="4" placeholder="Describe las características, materiales y estilo de tu producto..."></textarea>
                            <span asp-validation-for="Descripcion" class="form-error"></span>
                        </div>
                    </div>

                    <!-- Pricing & Inventory Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">Precio e Inventario</h3>

                        <div class="form-grid-2">
                            <div class="form-group">
                                <label asp-for="Precio" class="form-label">
                                    <i class="bi bi-currency-dollar"></i>
                                    Precio (₡)
                                </label>
                                <input asp-for="Precio" type="number" step="0.01" class="form-input" placeholder="15000.00" />
                                <span asp-validation-for="Precio" class="form-error"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Stock" class="form-label">
                                    <i class="bi bi-boxes"></i>
                                    Stock Disponible
                                </label>
                                <input asp-for="Stock" type="number" class="form-input" placeholder="50" />
                                <span asp-validation-for="Stock" class="form-error"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Classification Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">Clasificación</h3>

                        <!-- Categoría -->
                        <div class="form-group">
                            <label asp-for="IdCategoria" class="form-label">
                                <i class="bi bi-collection"></i>
                                Categoría
                            </label>
                            @Html.DropDownListFor(
                            m => m.IdCategoria,
                                                        new SelectList(ViewBag.ListCategoria, "IdCategoria", "NombreCategoria"),
                                                        "Seleccione una categoría",
                                                        new { @class = "form-select" }
                                                        )
                            <span asp-validation-for="IdCategoria" class="form-error"></span>
                        </div>

                        <!-- Etiquetas -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-tags"></i>
                                Etiquetas
                            </label>
                            <select id="selectedEtiquetas" name="selectedEtiquetas"
                                    class="form-select form-select-tags" asp-items="ViewBag.ListEtiquetas"
                                    multiple="multiple"></select>
                            <small class="form-help">
                                <i class="bi bi-info-circle"></i>
                                Use Ctrl o Cmd para seleccionar múltiples etiquetas
                            </small>
                            <span id="errorEtiquetas" class="form-error"></span>
                        </div>
                    </div>

                    <!-- Images Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">Imágenes del Producto</h3>

                        <div class="form-group">
                            <label for="ImageFiles" class="form-label">
                                <i class="bi bi-image"></i>
                                Cargar Imágenes
                            </label>

                            <!-- Custom File Upload -->
                            <div class="file-upload-container">
                                <input type="file" id="ImageFiles" name="ImageFiles" multiple accept="image/*" class="file-input-hidden" />
                                <div class="file-upload-area" onclick="document.getElementById('ImageFiles').click()">
                                    <div class="file-upload-icon">
                                        <i class="bi bi-cloud-upload"></i>
                                    </div>
                                    <div class="file-upload-text">
                                        <p class="upload-main-text">Arrastra imágenes aquí o haz click para seleccionar</p>
                                        <p class="upload-sub-text">Máximo 5 imágenes, 2 MB cada una</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Image Preview Grid -->
                            <div id="previewList" class="image-preview-grid"></div>
                            <span id="errorImagenes" class="form-error"></span>
                        </div>
                    </div>

                    <!-- Actions Section -->
                    <div class="form-actions">
                        <a asp-action="IndexAdmin" class="btn btn-ghost btn-lg">
                            <i class="bi bi-arrow-left"></i>
                            Cancelar
                        </a>
                        <button type="submit" id="btnSubmit" class="btn btn-primary btn-lg btn-submit">
                            <i class="bi bi-save"></i>
                            <span class="btn-text">Guardar Producto</span>
                            <div id="spinner" class="btn-spinner">
                                <i class="bi bi-arrow-clockwise"></i>
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        const form = document.getElementById('formCreateProducto');
        const btnSubmit = document.getElementById('btnSubmit');
        const spinner = document.getElementById('spinner');
        const btnText = document.querySelector('.btn-text');
        const previewContainer = document.getElementById('previewList');
        const inputImgs = document.getElementById('ImageFiles');
        const errorImgs = document.getElementById('errorImagenes');
        const errorTags = document.getElementById('errorEtiquetas');
        const fileUploadArea = document.querySelector('.file-upload-area');

        // Drag and Drop functionality
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });

        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
        });

        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            inputImgs.files = files;
            handleFilePreview(files);
        });

        // File preview handling
        inputImgs.addEventListener('change', function (event) {
            handleFilePreview(event.target.files);
        });

        function handleFilePreview(files) {
            previewContainer.innerHTML = '';
            errorImgs.textContent = '';

            const fileArray = Array.from(files);
            const MAX_FILES = 5;
            const MAX_MB = 2;
            const MAX_BYTES = MAX_MB * 1024 * 1024;

            if (fileArray.length > MAX_FILES) {
                errorImgs.textContent = `Máximo ${MAX_FILES} imágenes permitidas.`;
                inputImgs.value = '';
                return;
            }

            for (const file of fileArray) {
                if (file.size > MAX_BYTES) {
                    errorImgs.textContent = `Cada imagen debe pesar máximo ${MAX_MB} MB.`;
                    inputImgs.value = '';
                    return;
                }
            }

            fileArray.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <div class="preview-image-container">
                            <img src="${e.target.result}" alt="Preview ${index + 1}">
                            <div class="preview-overlay">
                                <button type="button" class="remove-image-btn" onclick="removePreviewImage(this)">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="preview-info">
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                        </div>
                    `;
                    previewContainer.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });

            // Update upload area text
            updateUploadAreaText(fileArray.length);
        }

        function removePreviewImage(button) {
            const previewItem = button.closest('.image-preview-item');
            previewItem.remove();

            // Reset file input
            inputImgs.value = '';

            // Update upload area text
            const remainingPreviews = previewContainer.querySelectorAll('.image-preview-item').length;
            updateUploadAreaText(remainingPreviews);
        }

        function updateUploadAreaText(count) {
            const mainText = document.querySelector('.upload-main-text');
            const subText = document.querySelector('.upload-sub-text');

            if (count > 0) {
                mainText.textContent = `${count} imagen${count > 1 ? 'es' : ''} seleccionada${count > 1 ? 's' : ''}`;
                subText.textContent = `Haz click para agregar más (máximo 5)`;
            } else {
                mainText.textContent = 'Arrastra imágenes aquí o haz click para seleccionar';
                subText.textContent = 'Máximo 5 imágenes, 2 MB cada una';
            }
        }

        function validateTags() {
            errorTags.textContent = '';
            const sel = document.getElementById('selectedEtiquetas');
            if ([...sel.selectedOptions].length === 0) {
                errorTags.textContent = "Seleccione al menos una etiqueta.";
                return false;
            }
            return true;
        }

        // Enhanced form submission
        form.addEventListener('submit', function (e) {
            errorImgs.textContent = '';

            if (!validateTags()) {
                e.preventDefault();
                return;
            }

            if (!form.checkValidity()) return;

            // Show loading state
            btnSubmit.disabled = true;
            btnSubmit.classList.add('loading');
            btnText.textContent = 'Guardando...';
            spinner.style.display = 'inline-block';

            // Show success notification
            setTimeout(() => {
                showNotification('🎉 ¡Producto creado exitosamente!', 'success');
            }, 500);
        });

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill'}"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
    </script>
}